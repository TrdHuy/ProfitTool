<!DOCTYPE html>
<html lang="vi">

<head>
     <meta charset="UTF-8">
     <title>Test FormattedInput</title>
     <style>
          body {
               font-family: "Segoe UI", sans-serif;
               padding: 20px;
               background: #f8f8f8;
          }

          /* CSS ngo√†i: host-level vars ƒë·ªÉ theme/override nhanh */
          formatted-input {
               display: inline-block;
               margin: 10px;
               --fi-border-color: #ccc;
               --fi-bg: #fff;
               --fi-text-color: #222;
               --fi-radius: 6px;
               --fi-padding: 6px 8px;
               --fi-font-size: 16px;
               --fi-width: 160px;
               --fi-focus: #66aaff;
          }

          formatted-input[format="vnd"] {
               --fi-text-color: darkgreen;
          }

          formatted-input[format="usd"] {
               --fi-text-color: darkblue;
          }
     </style>
</head>

<body>
     <h2>üî¢ Test Custom Element: &lt;formatted-input&gt;</h2>

     <div>
          <label>S·ªë th∆∞·ªùng:</label>
          <formatted-input id="f1" value="1000" format="number" step="1" min="-10"></formatted-input>
     </div>

     <div>
          <label>Ti·ªÅn Vi·ªát (VND):</label>
          <formatted-input id="f2" value="1000000" format="vnd" step="1000" min="0"></formatted-input>
     </div>

     <div>
          <label>USD:</label>
          <formatted-input id="f3" value="200" format="usd" step="1" min="0"></formatted-input>
     </div>

     <div>
          <label>Ph·∫ßn trƒÉm (%):</label>
          <formatted-input id="f4" value="12.5" format="percent" step="0.1" min="0" max="100"></formatted-input>
     </div>

     <hr>
     <p><b>Console log:</b> m·ªü DevTools (F12 ‚Üí tab Console) ƒë·ªÉ xem s·ª± ki·ªán <code>value-changed</code></p>

     <script>
          class FormattedInput extends HTMLElement {
               static get observedAttributes() {
                    // theo d√µi c·∫£ tham s·ªë s·ªë h·ªçc ƒë·ªÉ √°p d·ª•ng khi b·∫≠t spinner
                    return ["value", "format", "min", "max", "step", "spinner"];
               }

               constructor() {
                    super();
                    this._input = document.createElement("input");
                    // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã d·∫°ng text (ƒë·ªÉ cho ph√©p ch√®n k√Ω t·ª± ƒë·ªãnh d·∫°ng nh∆∞ "," ho·∫∑c " ‚Ç´")
                    this._input.type = "text";
                    this._input.inputMode = "decimal"; // g·ª£i √Ω b√†n ph√≠m s·ªë tr√™n mobile
                    this._rawValue = "";

                    const shadow = this.attachShadow({ mode: "open" });

                    // Style n·ªôi b·ªô cho Shadow DOM, s·ª≠ d·ª•ng bi·∫øn CSS t·ª´ host
                    const style = document.createElement("style");
                    style.textContent = `
          :host { display: inline-block; }
          input {
            font-size: var(--fi-font-size, 16px);
            padding: var(--fi-padding, 6px 8px);
            width: var(--fi-width, 160px);
            border: 1px solid var(--fi-border-color, #ccc);
            border-radius: var(--fi-radius, 6px);
            background: var(--fi-bg, #fff);
            color: var(--fi-text-color, #222);
            text-align: right;
            box-sizing: border-box;
          }
          input:focus {
            outline: none;
            border-color: var(--fi-focus, #66aaff);
            box-shadow: 0 0 2px var(--fi-focus, #66aaff);
          }
        `;

                    shadow.append(style, this._input);

                    // FOCUS: chuy·ªÉn sang type=number ƒë·ªÉ hi·ªÉn th·ªã m≈©i t√™n tƒÉng/gi·∫£m (spinner) n·∫øu ph√π h·ª£p
                    this._input.addEventListener("focus", () => {
                         this._input.value = this._rawValue ?? "";
                         if (this._shouldShowSpinner()) {
                              this._input.type = "number"; // b·∫≠t m≈©i t√™n ‚Üë‚Üì native
                              this._applyNumericAttrs();
                         }
                    });

                    // BLUR: quay l·∫°i type=text ƒë·ªÉ hi·ªÉn th·ªã gi√° tr·ªã ƒë√£ format (c√≥ k√Ω t·ª± ‚Ç´, %, d·∫•u , ...)
                    this._input.addEventListener("blur", () => {
                         // Chuy·ªÉn v·ªÅ text TR∆Ø·ªöC, r·ªìi m·ªõi set value ƒë·ªÉ tr√°nh 1 s·ªë tr√¨nh duy·ªát x√≥a gi√° tr·ªã khi ƒë·ªïi type
                         const current = this._input.value;
                         this._input.type = "text";
                         // N·∫øu ng∆∞·ªùi d√πng kh√¥ng nh·∫≠p g√¨ (""), gi·ªØ l·∫°i gi√° tr·ªã c≈© thay v√¨ bi·∫øn m·∫•t
                         const val = (current === "" || current == null) ? this._rawValue : current;
                         this.value = val; // setter s·∫Ω parse & format v√† c·∫≠p nh·∫≠t hi·ªÉn th·ªã
                    });

                    // CHANGE: ph√°t s·ª± ki·ªán ra ngo√†i
                    this._input.addEventListener("change", () => {
                         this._emitChanged();
                    });

                    // H·ªó tr·ª£ ph√≠m m≈©i t√™n ‚Üë‚Üì tƒÉng/gi·∫£m theo step khi ƒëang focus (k·ªÉ c·∫£ type=text)
                    this._input.addEventListener("keydown", (e) => {
                         if ((e.key === "ArrowUp" || e.key === "ArrowDown") && this._isNumericFormat()) {
                              e.preventDefault();
                              const step = this._readNumberAttr("step", 1);
                              const dir = e.key === "ArrowUp" ? 1 : -1;
                              let next = (parseFloat(this._input.value || this._rawValue) || 0) + dir * step;
                              const min = this._readNumberAttr("min", null);
                              const max = this._readNumberAttr("max", null);
                              if (min !== null) next = Math.max(min, next);
                              if (max !== null) next = Math.min(max, next);
                              this._input.value = String(next);
                         }
                    });
               }

               // ====== Formatters c√≥ th·ªÉ m·ªü r·ªông ======
               static FORMATTERS = {
                    number: (val) => {
                         const num = parseFloat(val);
                         return isNaN(num) ? "" : num.toLocaleString();
                    },
                    vnd: (val) => {
                         const num = parseFloat(val);
                         return isNaN(num) ? "" : num.toLocaleString("vi-VN") + " ‚Ç´";
                    },
                    usd: (val) => {
                         const num = parseFloat(val);
                         return isNaN(num) ? "" : "$" + num.toLocaleString("en-US");
                    },
                    percent: (val) => {
                         const num = parseFloat(val);
                         return isNaN(num) ? "" : num.toFixed(2) + "%";
                    },
               };

               // ====== Properties ======
               get value() { return this._rawValue; }
               set value(v) {
                    const num = parseFloat(String(v).replace(/[,\s]+/g, ""));
                    this._rawValue = isNaN(num) ? "" : num;
                    this._updateDisplay();
               }

               get format() { return this.getAttribute("format") || "number"; }
               set format(v) { this.setAttribute("format", v); }

               attributeChangedCallback(name, oldValue, newValue) {
                    if (oldValue === newValue) return;
                    if (name === "value") {
                         this.value = newValue;
                    } else if (name === "format") {
                         this._updateDisplay();
                    } else if (name === "min" || name === "max" || name === "step") {
                         // √°p d·ª•ng ngay n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô number
                         this._applyNumericAttrs();
                    }
               }

               // ====== Helpers ======
               _isNumericFormat() {
                    return ["number", "vnd", "usd", "percent"].includes(this.format);
               }
               _shouldShowSpinner() {
                    // spinner m·∫∑c ƒë·ªãnh b·∫≠t cho format s·ªë; c√≥ th·ªÉ t·∫Øt b·∫±ng spinner="off"
                    const attr = (this.getAttribute("spinner") || "on").toLowerCase();
                    return this._isNumericFormat() && attr !== "off";
               }
               _applyNumericAttrs() {
                    if (this._input.type !== "number") return;
                    const min = this.getAttribute("min");
                    const max = this.getAttribute("max");
                    const step = this.getAttribute("step");
                    if (min !== null) this._input.min = min; else this._input.removeAttribute("min");
                    if (max !== null) this._input.max = max; else this._input.removeAttribute("max");
                    if (step !== null) this._input.step = step; else this._input.removeAttribute("step");
               }
               _readNumberAttr(name, fallback) {
                    const v = this.getAttribute(name);
                    if (v === null || v === "") return fallback;
                    const n = Number(v);
                    return Number.isNaN(n) ? fallback : n;
               }
               _emitChanged() {
                    this.dispatchEvent(new CustomEvent("value-changed", {
                         detail: { value: this._rawValue },
                         bubbles: true,
                         composed: true,
                    }));
               }

               _updateDisplay() {
                    const fmt = FormattedInput.FORMATTERS[this.format];
                    if (fmt) this._input.value = fmt(this._rawValue);
                    else this._input.value = this._rawValue;
               }
          }

          customElements.define("formatted-input", FormattedInput);

          // Log s·ª± ki·ªán thay ƒë·ªïi
          document.querySelectorAll("formatted-input").forEach(el => {
               el.addEventListener("value-changed", e => {
                    console.log(`[${el.format}] changed ‚Üí`, e.detail.value);
               });
          });
     </script>
</body>

</html>