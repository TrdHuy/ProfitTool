<!DOCTYPE html>
<html lang="vi">

<head>
     <meta charset="UTF-8" />
     <title>FormattedInput ⟶ kế thừa AutoScrollInput (đủ style + formatters + spinner)</title>
     <style>
          body {
               font-family: "Segoe UI", sans-serif;
               padding: 20px;
               background: #f8f8f8;
          }

          /* Theme mặc định cho host – có thể override ở ngoài */
          formatted-input {
               display: inline-block;
               margin: 10px;
               --fi-border-color: #ccc;
               --fi-bg: #fff;
               --fi-text-color: #222;
               --fi-radius: 6px;
               --fi-padding: 6px 8px;
               --fi-font-size: 16px;
               --fi-width: 180px;
               --fi-focus: #66aaff;
          }

          /* Ví dụ đổi màu chữ theo format (có thể bỏ nếu không muốn) */
          formatted-input[format="currency"] {
               --fi-text-color: #0a6b0a;
          }

          formatted-input[format="usd"] {
               --fi-text-color: #0a4a8b;
          }

          formatted-input[readonly] input {
               background: #f0f0f0;
               color: #777;
               cursor: not-allowed;
          }
     </style>
</head>

<body>
     <h2>FormattedInput kế thừa AutoScrollInput</h2>
     <p>Hỗ trợ: <b>style biến CSS</b>, <b>formatters (number, currency/VND, usd, percent, decimal)</b>, <b>spinner với
               min/max/step</b>, <b>readonly</b>, và <b>sự kiện value-changed</b>.</p>

     <div>
          <label>Số thường:</label>
          <formatted-input id="f1" value="1000" format="number" step="1" min="0"></formatted-input>
     </div>
     <div>
          <label>VND:</label>
          <formatted-input id="f2" value="1000000" format="currency" step="1000" min="0"></formatted-input>
     </div>
     <div>
          <label>USD:</label>
          <formatted-input id="f3" value="200" format="usd" step="1" min="0"></formatted-input>
     </div>
     <div>
          <label>Phần trăm (%):</label>
          <formatted-input id="f4" value="12.5" format="percent" step="0.1" min="0" max="100"></formatted-input>
     </div>
     <div>
          <label>Decimal (2 chữ số):</label>
          <formatted-input id="f5" value="1234.567" format="decimal" step="0.01"></formatted-input>
     </div>
     <div>
          <label>Readonly:</label>
          <formatted-input id="f6" value="99999" format="currency" readonly></formatted-input>
     </div>

     <script>
          // ===== Base class =====
          class AutoScrollInput extends HTMLElement {
               constructor() {
                    super();
                    this._input = document.createElement('input');
                    this.appendChild(this._input);
               }
               connectedCallback() {
                    if (typeof isMobile !== 'undefined' && isMobile) {
                         this._input.addEventListener('focus', () => {
                              setTimeout(() => this._input.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
                         });
                    }
               }
               get value() { return this._input.value; }
               set value(v) { this._input.value = v; }
          }

          // ===== FormattedInput =====
          class FormattedInput extends AutoScrollInput {
               static get observedAttributes() {
                    return ["value", "format", "min", "max", "step", "spinner", "readonly"];
               }
               constructor() {
                    super();
                    this._rawValue = '';
                    this._updating = false; // chống vòng lặp attribute ↔ setter

                    // style nội bộ (không dùng shadow để cho phép CSS var từ host)
                    this._style = document.createElement('style');
                    this._style.textContent = `
          input {
            font-size: var(--fi-font-size, 16px);
            padding: var(--fi-padding, 6px 8px);
            width: var(--fi-width, 180px);
            border: 1px solid var(--fi-border-color, #ccc);
            border-radius: var(--fi-radius, 6px);
            background: var(--fi-bg, #fff);
            color: var(--fi-text-color, #222);
            text-align: right;
            box-sizing: border-box;
          }
          input:focus { outline: none; border-color: var(--fi-focus, #66aaff); box-shadow: 0 0 2px var(--fi-focus, #66aaff); }
        `;
                    this.appendChild(this._style);

                    // input mode – mặc định là text để hiển thị chuỗi format; sẽ chuyển sang number khi focus
                    this._input.type = 'text';
                    this._input.inputMode = 'decimal';

                    // Hiển thị giá trị đã format lần đầu nếu có attribute value
                    if (this.hasAttribute('value')) {
                         const num = this._parseToNumber(this.getAttribute('value'));
                         this._rawValue = isNaN(num) ? '' : num;
                         this._render();
                    }

                    // focus: hiện raw value + bật spinner nếu cần
                    this._input.addEventListener('focus', () => {
                         if (this._isReadonly()) return;
                         this._input.value = this._rawValue ?? '';
                         if (this._shouldShowSpinner()) {
                              this._input.type = 'number';
                              this._applyNumericAttrs();
                         }
                    });

                    // blur: chuyển về text trước rồi format lại; nếu rỗng, giữ nguyên giá trị cũ
                    this._input.addEventListener('blur', () => {
                         const current = this._input.value;
                         this._input.type = 'text';
                         const val = (current === '' || current == null) ? this._rawValue : current;
                         this.value = val; // setter sẽ parse & render
                    });

                    // change: bắn sự kiện cho cha biết
                    this._input.addEventListener('change', () => {
                         if (this._isReadonly()) return;
                         this._emitChanged();
                    });

                    // keyboard ↑↓: hỗ trợ step ngay cả khi type=text
                    this._input.addEventListener('keydown', (e) => {
                         if (this._isReadonly()) { e.preventDefault(); return; }
                         if ((e.key === 'ArrowUp' || e.key === 'ArrowDown') && this._isNumericFormat()) {
                              e.preventDefault();
                              const step = this._readNumberAttr('step', 1);
                              const dir = e.key === 'ArrowUp' ? 1 : -1;
                              let next = (parseFloat(this._input.value || this._rawValue) || 0) + dir * step;
                              const min = this._readNumberAttr('min', null);
                              const max = this._readNumberAttr('max', null);
                              if (min !== null) next = Math.max(min, next);
                              if (max !== null) next = Math.min(max, next);
                              this._input.value = String(next);
                         }
                    });
               }

               // ===== Formatters =====
               static FORMATTERS = {
                    number: (v) => {
                         const n = parseFloat(v); return isNaN(n) ? '' : n.toLocaleString('vi-VN');
                    },
                    currency: (v) => { // VND mặc định
                         const n = parseFloat(v); return isNaN(n) ? '' : new Intl.NumberFormat('vi-VN').format(n) + ' ₫';
                    },
                    vnd: (v) => FormattedInput.FORMATTERS.currency(v),
                    usd: (v) => {
                         const n = parseFloat(v); return isNaN(n) ? '' : '$' + n.toLocaleString('en-US');
                    },
                    percent: (v) => {
                         const n = parseFloat(v); return isNaN(n) ? '' : n.toFixed(2) + '%';
                    },
                    decimal: (v) => {
                         const n = parseFloat(v); return isNaN(n) ? '' : n.toLocaleString('vi-VN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    },
               };

               // ===== Public API (properties) =====
               get value() { return this._rawValue; }
               set value(v) {
                    const num = this._parseToNumber(v);
                    this._rawValue = isNaN(num) ? '' : num;
                    this._render(true);
                    // đồng bộ attribute value nhưng tránh vòng lặp
                    if (!this._updating) {
                         this._updating = true;
                         this.setAttribute('value', String(this._rawValue));
                         this._updating = false;
                    }
               }

               get format() { return (this.getAttribute('format') || 'number').toLowerCase(); }
               set format(v) { this.setAttribute('format', v); }

               // ===== Lifecycle for attributes =====
               attributeChangedCallback(name, oldVal, newVal) {
                    if (oldVal === newVal) return;
                    if (name === 'value') {
                         if (!this._updating) this.value = newVal; // sẽ parse + render
                    } else if (name === 'format') {
                         this._render();
                    } else if (name === 'readonly') {
                         this._updateReadonly();
                    } else if (name === 'min' || name === 'max' || name === 'step') {
                         this._applyNumericAttrs();
                    }
               }

               // ===== Helpers =====
               _render(initial = false) {
                    const fmt = FormattedInput.FORMATTERS[this.format];
                    if (fmt) this._input.value = fmt(this._rawValue);
                    else this._input.value = this._rawValue;
                    if (!initial) this._updateReadonly();
               }
               _parseToNumber(val) {
                    const cleaned = String(val ?? '').replace(/[^0-9eE+\.\-]/g, '');
                    return parseFloat(cleaned);
               }
               _isReadonly() { return this.hasAttribute('readonly'); }
               _updateReadonly() {
                    if (this._isReadonly()) this._input.setAttribute('readonly', 'true');
                    else this._input.removeAttribute('readonly');
               }
               _isNumericFormat() { return ['number', 'currency', 'vnd', 'usd', 'percent', 'decimal'].includes(this.format); }
               _shouldShowSpinner() { const a = (this.getAttribute('spinner') || 'on').toLowerCase(); return this._isNumericFormat() && a !== 'off'; }
               _applyNumericAttrs() {
                    if (this._input.type !== 'number') return;
                    const min = this.getAttribute('min');
                    const max = this.getAttribute('max');
                    const step = this.getAttribute('step');
                    if (min !== null) this._input.min = min; else this._input.removeAttribute('min');
                    if (max !== null) this._input.max = max; else this._input.removeAttribute('max');
                    if (step !== null) this._input.step = step; else this._input.removeAttribute('step');
               }
               _readNumberAttr(name, fallback) {
                    const v = this.getAttribute(name);
                    if (v === null || v === '') return fallback;
                    const n = Number(v);
                    return Number.isNaN(n) ? fallback : n;
               }
               _emitChanged() {
                    this.dispatchEvent(new CustomEvent('value-changed', { detail: { value: this._rawValue }, bubbles: true, composed: true }));
               }
          }

          customElements.define('auto-scroll-input', AutoScrollInput);
          customElements.define('formatted-input', FormattedInput);

          // Demo: lắng nghe thay đổi
          document.querySelectorAll('formatted-input').forEach(el => {
               el.addEventListener('value-changed', e => console.log(`[${el.id || el.format}] →`, e.detail.value));
          });
     </script>
</body>

</html>