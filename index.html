<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Param Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 700px;
            margin: auto;
        }

        h2,
        h3 {
            text-align: center;
        }

        .block {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .scroll-box {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
            margin-top: 10px;
            border-radius: 4px;
            background: #fafafa;
        }

        label {
            display: block;
            margin-top: 5px;
        }

        input {
            padding: 5px;
            margin: 3px 0;
        }

        button {
            margin-top: 10px;
            padding: 6px 12px;
        }

        .param-item,
        .formula-item {
            margin: 5px 0;
        }

        .formula-result {
            font-weight: bold;
            color: darkblue;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .menubar {
            display: flex;
            gap: 10px;
            background: #f0f0f0;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 15px;
            align-items: center;
        }

        /* Style n√∫t */
        .menubar button,
        .menubar .menu-btn {
            margin: 2px;
            background: #ffffff;
            border: 1px solid #bbb;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s, box-shadow 0.2s;
        }

        /* Hover effect */
        .menubar button:hover,
        .menubar .menu-btn:hover {
            background: #e6f0ff;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
        }

        /* ·∫®n input file th·∫≠t, ch·ªâ show label gi·∫£ n√∫t */
        #importFile {
            display: none;
        }

        .formula-block {
            flex: 1;
            /* t·ª± chi·∫øm ph·∫ßn c√≤n l·∫°i */
        }

        .mouse-effect-no-select {
            user-select: none;
            /* chu·∫©n */
            -webkit-user-select: none;
            /* Safari/Chrome */
            -ms-user-select: none;
            /* IE/Edge c≈© */
        }

        /* Khi xoay ngang (chi·ªÅu r·ªông > chi·ªÅu cao) th√¨ ƒë·ªïi layout ngang */
        /* Mobile th∆∞·ªùng c√≥ pointer: coarse (ng√≥n tay), c√≤n PC l√† fine (chu·ªôt) */
        @media (orientation: landscape) and (pointer: coarse) {
            .container {
                display: flex;
                flex-direction: row;
                height: 100%;
                gap: 0px;
            }

            .divider {
                width: 30px;
                cursor: col-resize;
                background: #ddd;
            }

            .divider:hover {
                background: #aaa;
            }

            .param-block {
                min-width: 30%;
                max-width: 60%;
            }
        }
    </style>
</head>

<body>
    <h2>Param Editor</h2>
    <div class="menubar">
        <button onclick="exportData()">üíæ Export</button>

        <label for="importFile" class="menu-btn">üìÇ Import</label>
        <input type="file" id="importFile" accept=".json" onchange="importData(this)">
    </div>
    <div class="container" id="mainContainer">
        <!-- Th√™m tham s·ªë -->
        <div class="block param-block" id="paramContainer">
            <h3 onclick="toggleBlock('paramBlock')" style="cursor:pointer;">
                ‚ûï Th√™m tham s·ªë
            </h3>

            <div id="paramBlock">
                <label>T√™n param:</label>
                <input type="text" id="paramName" placeholder="V√≠ d·ª•: A">
                <label>M√¥ t·∫£:</label>
                <input type="text" id="paramDesc" placeholder="V√≠ d·ª•: s·ªë l∆∞·ª£ng m√°y">
                <label>Gi√° tr·ªã:</label>
                <input type="number" id="paramValue" placeholder="V√≠ d·ª•: 10">
                <button onclick="addParam()" id="addParamButton">Th√™m tham s·ªë</button>
                <div id="params" class="scroll-box"></div>
            </div>
        </div>

        <div class="divider" id="divider"></div>
        <!-- Th√™m c√¥ng th·ª©c -->
        <div class="block formula-block" id="formulaContainer">
            <h3>Th√™m c√¥ng th·ª©c</h3>
            <label>T√™n c√¥ng th·ª©c:</label>
            <input type="text" id="formulaName" placeholder="V√≠ d·ª•: Doanh thu">
            <label>M√¥ t·∫£:</label>
            <input type="text" id="formulaDesc" placeholder="V√≠ d·ª•: doanh thu h√†ng th√°ng">
            <label>C√¥ng th·ª©c:</label>
            <input type="text" id="formulaInput" placeholder="V√≠ d·ª•: A + B * 2">
            <button onclick="addFormula()" id="addFormulaButton">Th√™m c√¥ng th·ª©c</button>
            <div id="formulas" class="scroll-box"></div>
        </div>


    </div>

    <script>
        //#region X·ª≠ l√Ω layout divider
        const divider = document.getElementById("divider");
        const mainContainer = document.getElementById("mainContainer");
        const paramContainer = document.getElementById("paramContainer");

        let isResizing = false;

        divider.addEventListener("mousedown", startResize);
        divider.addEventListener("touchstart", startResize, { passive: false });

        function startResize(e) {
            isResizing = true;
            document.body.classList.add("mouse-effect-no-select");
            document.addEventListener("mousemove", resize);
            document.addEventListener("mouseup", stopResize);
            document.addEventListener("touchmove", resize, { passive: false });
            document.addEventListener("touchend", stopResize);
        }

        function resize(e) {
            if (!isResizing) return;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;

            // T√≠nh t·ªça ƒë·ªô X t∆∞∆°ng ƒë·ªëi trong container
            const rect = mainContainer.getBoundingClientRect();
            const dividerWidth = divider.getBoundingClientRect().width;
            let x = clientX - rect.left;               // px t·ª´ m√©p tr√°i container
            let newWidth = ((x - dividerWidth / 2) / rect.width) * 100;     // ƒë·ªïi sang %

            // Gi·ªõi h·∫°n min‚Äìmax
            const MIN_PCT = 30, MAX_PCT = 60;
            if (newWidth < MIN_PCT) newWidth = MIN_PCT;
            if (newWidth > MAX_PCT) newWidth = MAX_PCT;

            // Set flex-basis ƒë·ªÉ ƒë·ªïi chi·ªÅu r·ªông c·ªôt tr√°i
            paramContainer.style.flexBasis = `${newWidth}%`;

            // NgƒÉn scroll khi k√©o tr√™n mobile
            if (e.cancelable) e.preventDefault();

            // Debug
            // console.log("x=", x, "rect.width=", rect.width, "newWidth%=", newWidth);
        }

        function stopResize() {
            isResizing = false;
            document.body.classList.remove("mouse-effect-no-select");
            document.removeEventListener("mousemove", resize);
            document.removeEventListener("mouseup", stopResize);
            document.removeEventListener("touchmove", resize);
            document.removeEventListener("touchend", stopResize);
        }
        //#endregion

        //#region Param
        let params = {};          // l∆∞u param
        let editingParamName = null;

        function editParam(name) {
            const p = params[name];
            if (!p) return;

            // Fill input
            document.getElementById("paramName").value = name;
            document.getElementById("paramValue").value = p.value;
            document.getElementById("paramDesc").value = p.desc || "";
            document.getElementById("addParamButton").innerHTML = "C·∫≠p nh·∫≠t";
            editingParamName = name; // ƒë√°nh d·∫•u ƒëang edit
        }

        function addParam() {
            const name = document.getElementById("paramName").value.trim();
            const value = parseFloat(document.getElementById("paramValue").value);
            const desc = document.getElementById("paramDesc").value.trim();

            if (!name) { alert("T√™n param kh√¥ng ƒë∆∞·ª£c r·ªóng!"); return; }
            if (isNaN(value)) { alert("Gi√° tr·ªã ph·∫£i l√† s·ªë!"); return; }

            // N·∫øu ƒëang edit ‚Üí update
            if (editingParamName) {
                delete params[editingParamName];
                document.getElementById("addParamButton").innerHTML = "Th√™m tham s·ªë";
                editingParamName = null;
            }

            params[name] = { value: value, desc: desc };

            renderParams();
            updateResults();

            // reset input
            document.getElementById("paramName").value = "";
            document.getElementById("paramValue").value = "";
            document.getElementById("paramDesc").value = "";
        }


        function exportData() {
            // H·ªèi t√™n file
            let filename = prompt("Nh·∫≠p t√™n file ƒë·ªÉ l∆∞u:", "pt-data");
            if (filename === null) return; // user b·∫•m Cancel
            filename = filename.trim() || "pt-data"; // n·∫øu b·ªè tr·ªëng th√¨ l·∫•y m·∫∑c ƒë·ªãnh

            // Gom d·ªØ li·ªáu
            const data = {
                params: params,
                formulas: formulas
            };

            // T·∫°o file JSON
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename.endsWith(".json") ? filename : filename + ".json";
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    params = data.params || {};
                    formulas = data.formulas || {};
                    renderParams();
                    renderFormulas();
                    updateResults();
                    alert("Import d·ªØ li·ªáu th√†nh c√¥ng!");
                } catch (err) {
                    alert("File kh√¥ng h·ª£p l·ªá: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        function toggleBlock(id) {
            const el = document.getElementById(id);
            const title = el.previousElementSibling; // h3
            if (el.style.display === "none") {
                el.style.display = "block";
                title.innerText = title.innerText.replace("‚ûï", "‚ûñ");
            } else {
                el.style.display = "none";
                title.innerText = title.innerText.replace("‚ûñ", "‚ûï");
            }
        }

        function deleteParam(key) {
            delete params[key];
            renderParams();
            updateResults();
        }

        // Render danh s√°ch param v·ªõi input ƒë·ªÉ ch·ªânh s·ª≠a realtime
        function renderParams() {
            let html = "<h4>Danh s√°ch tham s·ªë:</h4>";
            for (let key in params) {
                let p = params[key];
                html += `
      <div class="param-item" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          ${key} = 
          <input type="number" value="${p.value}" onchange="updateParam('${key}', this.value)">
          <div style="font-size:12px; color:#666;">${p.desc || ""}</div>
        </div>
        <div>
          <button onclick="editParam('${key}')">‚úèÔ∏è</button>
          <button onclick="deleteParam('${key}')">‚ùå</button>
        </div>
      </div>`;
            }
            document.getElementById("params").innerHTML = html;
        }

        // C·∫≠p nh·∫≠t gi√° tr·ªã param
        function updateParam(key, value) {
            if (params[key]) {
                params[key].value = parseFloat(value) || 0;
                updateResults();
            }
        }
        //#endregion

        //#region Formula
        let formulas = {};   // key = t√™n c√¥ng th·ª©c, value = { raw, display }
        let editingFormulaName = null;

        // Format c√¥ng th·ª©c: th√™m kho·∫£ng tr·∫Øng v√† ƒë·ªïi * th√†nh √ó
        function formatFormulaDisplay(formula) {
            return formula
                .replace(/\*/g, "√ó")              // ƒë·ªïi d·∫•u nh√¢n
                .replace(/\//g, "√∑")              // c√≥ th·ªÉ ƒë·ªïi d·∫•u chia
                .replace(/([\+\-\√ó√∑])/g, " $1 ")  // th√™m kho·∫£ng tr·∫Øng quanh to√°n t·ª≠
                .replace(/\s+/g, " ")             // g·ªôp nhi·ªÅu kho·∫£ng tr·∫Øng th√†nh 1
                .trim();
        }

        function deleteFormula(name) {
            delete formulas[name];
            renderFormulas();
            updateResults();
        }

        function editFormula(name) {
            const f = formulas[name];
            if (!f) return;

            document.getElementById("formulaName").value = name;
            document.getElementById("formulaInput").value = f.raw;
            document.getElementById("formulaDesc").value = f.desc || "";

            editingFormulaName = name;
        }

        function addFormula() {
            const name = document.getElementById("formulaName").value.trim() || `C${Object.keys(formulas).length + 1}`;
            const formula = document.getElementById("formulaInput").value.trim();
            const desc = document.getElementById("formulaDesc").value.trim();

            if (!formula) { alert("Ch∆∞a nh·∫≠p c√¥ng th·ª©c!"); return; }

            // N·∫øu ƒëang edit ‚Üí x√≥a c√¥ng th·ª©c c≈©
            if (editingFormulaName) {
                document.getElementById("addFormulaButton").innerHTML = "Th√™m c√¥ng th·ª©c";
                delete formulas[editingFormulaName];
                editingFormulaName = null;
            }

            formulas[name] = {
                raw: formula,
                display: formatFormulaDisplay(formula),
                desc: desc
            };

            renderFormulas();
            updateResults();

            document.getElementById("formulaName").value = "";
            document.getElementById("formulaInput").value = "";
            document.getElementById("formulaDesc").value = "";
        }

        // Render danh s√°ch c√¥ng th·ª©c
        function renderFormulas() {
            let html = "<h4>Danh s√°ch c√¥ng th·ª©c:</h4>";
            for (let [name, f] of Object.entries(formulas)) {
                html += `
      <div class="formula-item" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <span><b>${name}</b>: <span id="formulaDisplay_${name}">${f.display}</span></span>
          <span id="formulaResult_${name}" class="formula-result"></span>
          <div style="font-size:12px; color:#666;">${f.desc || ""}</div>
        </div>
        <div>
          <button onclick="editFormula('${name}')">‚úèÔ∏è</button>
          <button onclick="deleteFormula('${name}')">‚ùå</button>
        </div>
      </div>`;
            }
            document.getElementById("formulas").innerHTML = html;
        }
        // T√≠nh to√°n l·∫°i t·∫•t c·∫£ c√¥ng th·ª©c
        function updateResults() {
            let scope = { ...params };

            for (let [name, f] of Object.entries(formulas)) {
                try {
                    let keys = Object.keys(scope);
                    let values = Object.values(scope);
                    let func = new Function(...keys, `return ${f.raw};`);
                    let result = func(...values);

                    scope[name] = result;
                    document.getElementById("formulaResult_" + name).innerText = " = " + result;

                    // reset c√¥ng th·ª©c v·ªÅ display g·ªëc khi t√≠nh th√†nh c√¥ng
                    document.getElementById("formulaDisplay_" + name).innerHTML = f.display;

                } catch (e) {
                    // L·∫•y bi·∫øn ch∆∞a c√≥ trong scope
                    let tokens = f.raw.match(/[a-zA-Z_]\w*/g) || [];
                    let missing = tokens.filter(t => !(t in scope));

                    if (missing.length > 0) {
                        // highlight ƒë·ªè trong display
                        let highlighted = f.display.replace(
                            new RegExp("\\b(" + missing.join("|") + ")\\b", "g"),
                            '<span style="color:red;font-weight:bold;">$1</span>'
                        );
                        document.getElementById("formulaDisplay_" + name).innerHTML = highlighted;

                        document.getElementById("formulaResult_" + name).innerText =
                            " (Thi·∫øu: " + missing.join(", ") + ")";
                    } else if (/Unexpected/.test(e.message)) {
                        document.getElementById("formulaResult_" + name).innerText = " (L·ªói c√∫ ph√°p)";
                    } else {
                        document.getElementById("formulaResult_" + name).innerText = " (L·ªói: " + e.message + ")";
                    }
                }
            }
        }
        //#endregion
    </script>
</body>

</html>