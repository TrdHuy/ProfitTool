<!DOCTYPE html>
<html lang="vi">

<head>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <meta charset="UTF-8">
    <title>Param Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <style>
        body {
            font-family: 'Inter', 'Roboto', sans-serif;
            font-size: 14px;
            color: #333;
            padding: 20px;
            margin: auto;
        }

        h2,
        h3 {
            text-align: center;
        }

        /* #region list-item*/
        /* Param v√† Formula item chung */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-radius: 4px;
            margin: 3px 0;
            background: var(--list-item-bg, #fafafa);
            /* default m√†u */
            transition: background 0.2s, transform 0.1s;
        }

        .list-item:hover {
            background: #f5faff;
        }

        .list-item:active {
            background: #dbe9ff;
            transform: scale(0.98);
        }

        /* Khi long-press (d√†nh cho mobile, th√™m class .long-press b·∫±ng JS) */
        .list-item.long-press {
            background: #ffe8cc;
            /* cam nh·∫°t */
        }


        /* #endregion */
        .block {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .scroll-box {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
            margin-top: 10px;
            border-radius: 4px;
            background: #fafafa;
        }

        label {
            display: block;
            margin-top: 5px;
        }

        input {
            padding: 5px;
            margin: 3px 0;
        }

        button {
            margin-top: 10px;
            padding: 6px 12px;
        }

        .formula-result {
            font-weight: bold;
            color: darkblue;
        }

        .group-header {
            background: #eee;
            padding: 5px;
            margin-top: 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        .group-header:hover {
            background: #ddd;
        }


        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .menubar {
            display: flex;
            gap: 10px;
            background: #f0f0f0;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 15px;
            align-items: center;
        }

        /* Style n√∫t */
        .menubar button,
        .menubar .menu-btn {
            margin: 2px;
            background: #ffffff;
            border: 1px solid #bbb;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s, box-shadow 0.2s;
        }

        /* Hover effect */
        .menubar button:hover,
        .menubar .menu-btn:hover {
            background: #e6f0ff;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
        }

        .context-menu {
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 120px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
        }

        .context-menu-item {
            padding: 6px 10px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .context-menu-item:hover {
            background: #f0f0f0;
        }

        /* ·∫®n input file th·∫≠t, ch·ªâ show label gi·∫£ n√∫t */
        #importFile {
            display: none;
        }

        .formula-block {
            flex: 1;
            /* t·ª± chi·∫øm ph·∫ßn c√≤n l·∫°i */
        }

        .mouse-effect-no-select {
            user-select: none;
            /* chu·∫©n */
            -webkit-user-select: none;
            /* Safari/Chrome */
            -ms-user-select: none;
            /* IE/Edge c≈© */
        }

        /* Khi xoay ngang (chi·ªÅu r·ªông > chi·ªÅu cao) th√¨ ƒë·ªïi layout ngang */
        /* Mobile th∆∞·ªùng c√≥ pointer: coarse (ng√≥n tay), c√≤n PC l√† fine (chu·ªôt) */
        @media (orientation: landscape) {
            .container {
                display: flex;
                flex-direction: row;
                height: 100%;
                gap: 0px;
            }

            .divider {
                width: 30px;
                cursor: col-resize;
                background: #ddd;
            }

            .divider:hover {
                background: #aaa;
            }

            .param-block {
                min-width: 30%;
                max-width: 60%;
            }
        }

        @media (orientation: landscape) and (pointer: coarse) {
            .container {
                display: flex;
                flex-direction: row;
                height: 100%;
                gap: 0px;
            }

            .divider {
                width: 10px;
                cursor: col-resize;
                background: #ddd;
            }

            .divider:hover {
                background: #aaa;
            }

            .param-block {
                min-width: 30%;
                max-width: 60%;
            }
        }
    </style>
</head>

<body>
    <h2>Param Editor</h2>
    <div class="menubar">
        <button onclick="exportData()">üíæ Export</button>

        <label for="importFile" class="menu-btn">üìÇ Import</label>
        <input type="file" id="importFile" accept=".json" onchange="importData(this)">
        <button onclick="clearWorkspace()">üßπ Clear</button>
        <button onclick="toggleFullscreen()">üî≥ Toggle Fullscreen</button>

    </div>
    <div class="container" id="mainContainer">
        <!-- Th√™m tham s·ªë -->
        <div class="block param-block" id="paramContainer">
            <h3 onclick="toggleBlock('paramBlock')" style="cursor:pointer;">
                ‚ûï Th√™m tham s·ªë
            </h3>

            <div id="paramBlock">
                <label>T√™n param:</label>
                <auto-scroll-input type="text" id="paramName" placeholder="V√≠ d·ª•: A"></auto-scroll-input>
                <label>M√¥ t·∫£:</label>
                <auto-scroll-input type="text" id="paramDesc" placeholder="V√≠ d·ª•: s·ªë l∆∞·ª£ng m√°y"></auto-scroll-input>
                <label>Gi√° tr·ªã:</label>
                <auto-scroll-input type="number" id="paramValue" placeholder="V√≠ d·ª•: 10"></auto-scroll-input>
                <label>Group:</label>
                <auto-scroll-input type="text" id="paramGroup" placeholder="V√≠ d·ª•: Nh√¢n s·ª±"></auto-scroll-input>

                <label>M√†u n·ªÅn:</label>
                <input type="color" id="paramColor" value="#f0f0f0">

                <label>Format:</label>
                <select id="paramFormat">
                    <option value="">(M·∫∑c ƒë·ªãnh)</option>
                    <option value="currency">Ti·ªÅn t·ªá (VND)</option>
                    <option value="decimal">S·ªë th·∫≠p ph√¢n</option>
                    <option value="percent">Ph·∫ßn trƒÉm</option>
                </select>

                <button onclick="addParam()" id="addParamButton">Th√™m tham s·ªë</button>
            </div>
            <div id="params" class="scroll-box"></div>

        </div>

        <div class="divider" id="divider"></div>
        <!-- Th√™m c√¥ng th·ª©c -->
        <div class="block formula-block" id="formulaContainer">
            <h3>Th√™m c√¥ng th·ª©c</h3>
            <label>T√™n c√¥ng th·ª©c:</label>
            <auto-scroll-input type="text" id="formulaName" placeholder="V√≠ d·ª•: Doanh thu"></auto-scroll-input>
            <label>M√¥ t·∫£:</label>
            <auto-scroll-input type="text" id="formulaDesc"
                placeholder="V√≠ d·ª•: doanh thu h√†ng th√°ng"></auto-scroll-input>
            <label>C√¥ng th·ª©c:</label>
            <auto-scroll-input type="text" id="formulaInput" placeholder="V√≠ d·ª•: A + B * 2"></auto-scroll-input>
            <button onclick="addFormula()" id="addFormulaButton">Th√™m c√¥ng th·ª©c</button>
            <div id="formulas" class="scroll-box"></div>
        </div>


    </div>
    <div id="contextMenu" class="context-menu">
    </div>

    <script>

        const isMobile = /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);

        class AutoScrollInput extends HTMLElement {
            connectedCallback() {
                // n·∫øu trong tag ch∆∞a c√≥ input th√¨ m·ªõi t·∫°o
                if (!this.querySelector("input")) {
                    const input = document.createElement("input");

                    // copy to√†n b·ªô attribute t·ª´ custom tag xu·ªëng input
                    Array.from(this.attributes).forEach(attr => {
                        input.setAttribute(attr.name, attr.value);
                    });

                    // auto scroll khi focus
                    input.addEventListener("focus", () => {
                        if (isMobile) {
                            setTimeout(() => {
                                input.scrollIntoView({ behavior: "smooth", block: "center" });
                            }, 300);
                        }
                    });
                    this.appendChild(input);
                }
            }

            // getter/setter ƒë·ªÉ d√πng nh∆∞ <input>
            get value() {
                return this.querySelector("input")?.value;
            }
            set value(val) {
                if (this.querySelector("input")) {
                    this.querySelector("input").value = val;
                }
            }
        }

        class FormattedInput extends AutoScrollInput {
            connectedCallback() {
                super.connectedCallback();
                const input = this.querySelector("input");

                const format = this.getAttribute("format") || "";

                // set gi√° tr·ªã ban ƒë·∫ßu (formatted)
                if (this.hasAttribute("value")) {
                    input.value = this.formatValue(this.getAttribute("value"), format);
                }

                // Khi focus ‚Üí hi·ªán raw value
                input.addEventListener("focus", () => {
                    const raw = this.getAttribute("value");
                    if (raw !== null) input.value = raw;
                });

                // Khi blur ‚Üí format l·∫°i
                input.addEventListener("blur", () => {
                    let val = input.value;
                    let num = parseFloat(val.replace(/[^\d.-]/g, ""));
                    if (isNaN(num)) num = 0;

                    this.setAttribute("value", num); // update attribute ƒë·ªÉ ƒë·ªìng b·ªô
                    input.value = this.formatValue(num, format);

                    // trigger s·ª± ki·ªán custom ƒë·ªÉ cha bi·∫øt c√≥ update
                    //this.dispatchEvent(new CustomEvent("valueChanged", { detail: { key: this.id, value: num } }));
                });

                input.addEventListener("blur", () => {
                    let val = input.value;
                    let num = parseFloat(val.replace(/[^\d.-]/g, ""));
                    if (isNaN(num)) num = 0;

                    this.setAttribute("value", num); // update attribute ƒë·ªÉ ƒë·ªìng b·ªô
                    input.value = this.formatValue(num, format);

                    // trigger s·ª± ki·ªán custom ƒë·ªÉ cha bi·∫øt c√≥ update
                    //this.dispatchEvent(new CustomEvent("valueChanged", { detail: { key: this.id, value: num } }));
                });
            }

            formatValue(val, format) {
                if (val == null || isNaN(val)) return val;
                switch (format) {
                    case "currency":
                        return new Intl.NumberFormat("vi-VN").format(val) + " VND";
                    case "decimal":
                        return new Intl.NumberFormat("vi-VN", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);
                    case "percent":
                        return val + " %";
                    default:
                        return val;
                }
            }

            get value() { return parseFloat(this.getAttribute("value")); }
            set value(val) {
                this.setAttribute("value", val);
                const format = this.getAttribute("format") || "";
                this.querySelector("input").value = this.formatValue(val, format);
            }
        }


        //#region View function
        function toggleFullscreen() {
            const btn = document.getElementById("fullscreenBtn");

            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                // V√†o fullscreen
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                }
                btn.innerText = "‚ùé Tho√°t Fullscreen";
            } else {
                // Tho√°t fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                btn.innerText = "üî≥ V√†o Fullscreen";
            }
        }

        function exportData() {
            // H·ªèi t√™n file
            let filename = prompt("Nh·∫≠p t√™n file ƒë·ªÉ l∆∞u:", "pt-data");
            if (filename === null) return; // user b·∫•m Cancel
            filename = filename.trim() || "pt-data"; // n·∫øu b·ªè tr·ªëng th√¨ l·∫•y m·∫∑c ƒë·ªãnh

            // Gom d·ªØ li·ªáu
            const data = {
                params: params,
                formulas: formulas
            };
            saveToLocal(data)
            // T·∫°o file JSON
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename.endsWith(".json") ? filename : filename + ".json";
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    params = data.params || {};
                    formulas = data.formulas || {};
                    renderParams();
                    renderFormulas();
                    updateFormulaResults();
                    alert("Import d·ªØ li·ªáu th√†nh c√¥ng!");
                } catch (err) {
                    alert("File kh√¥ng h·ª£p l·ªá: " + err.message);
                }
            };
            reader.readAsText(file);
        }
        //#region X·ª≠ l√Ω layout divider
        const divider = document.getElementById("divider");
        const mainContainer = document.getElementById("mainContainer");
        const paramContainer = document.getElementById("paramContainer");

        let isResizing = false;

        divider.addEventListener("mousedown", startResize);
        divider.addEventListener("touchstart", startResize, { passive: false });

        function startResize(e) {
            isResizing = true;
            document.body.classList.add("mouse-effect-no-select");
            document.addEventListener("mousemove", resize);
            document.addEventListener("mouseup", stopResize);
            document.addEventListener("touchmove", resize, { passive: false });
            document.addEventListener("touchend", stopResize);
        }

        function resize(e) {
            if (!isResizing) return;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;

            // T√≠nh t·ªça ƒë·ªô X t∆∞∆°ng ƒë·ªëi trong container
            const rect = mainContainer.getBoundingClientRect();
            const dividerWidth = divider.getBoundingClientRect().width;
            let x = clientX - rect.left;               // px t·ª´ m√©p tr√°i container
            let newWidth = ((x - dividerWidth / 2) / rect.width) * 100;     // ƒë·ªïi sang %

            // Gi·ªõi h·∫°n min‚Äìmax
            const MIN_PCT = 30, MAX_PCT = 60;
            if (newWidth < MIN_PCT) newWidth = MIN_PCT;
            if (newWidth > MAX_PCT) newWidth = MAX_PCT;

            // Set flex-basis ƒë·ªÉ ƒë·ªïi chi·ªÅu r·ªông c·ªôt tr√°i
            paramContainer.style.flexBasis = `${newWidth}%`;

            // NgƒÉn scroll khi k√©o tr√™n mobile
            if (e.cancelable) e.preventDefault();

            // Debug
            // console.log("x=", x, "rect.width=", rect.width, "newWidth%=", newWidth);
        }

        function stopResize() {
            isResizing = false;
            document.body.classList.remove("mouse-effect-no-select");
            document.removeEventListener("mousemove", resize);
            document.removeEventListener("mouseup", stopResize);
            document.removeEventListener("touchmove", resize);
            document.removeEventListener("touchend", stopResize);
        }
        //#endregion

        //#endregion

        //#region Utils
        function formatValue(val, format) {
            console.log("formatValue");

            if (val == null || isNaN(val)) return val;

            switch (format) {
                case "currency":
                    return new Intl.NumberFormat("vi-VN").format(val) + " VND";
                case "decimal":
                    return new Intl.NumberFormat("vi-VN", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);
                case "percent":
                    return val + " %";
                default:
                    return val; // m·∫∑c ƒë·ªãnh: hi·ªÉn th·ªã raw
            }
        }
        //#endregion

        //#region List Context Menu
        let currentType = null;
        let currentName = null;
        const menu = document.getElementById("contextMenu");

        const MENU_ACTIONS = {
            param: [
                { icon: "‚úèÔ∏è", label: "Edit", action: (name) => editParam(name) },
                { icon: "‚ùå", label: "Delete", action: (name) => deleteParam(name) }
            ],
            formula: [
                { icon: "‚úèÔ∏è", label: "Edit", action: (name) => editFormula(name) },
                { icon: "‚ùå", label: "Delete", action: (name) => deleteFormula(name) }
            ]
        };

        function openContextMenu(e, type, name) {
            e.preventDefault();
            currentType = type;
            currentName = name;

            // Build menu items theo type
            menu.innerHTML = MENU_ACTIONS[type]
                .map(item => `
      <div class="context-menu-item" onclick="handleContext('${item.label}')">
        ${item.icon} ${item.label}
      </div>
    `).join("");

            menu.style.display = "block";
            menu.style.left = e.pageX + "px";
            menu.style.top = e.pageY + "px";
        }

        function handleContext(label) {
            if (!currentType || !currentName) return;
            const item = MENU_ACTIONS[currentType].find(x => x.label === label);
            if (item) item.action(currentName);
            menu.style.display = "none";
        }

        // ·∫®n menu khi click ra ngo√†i
        document.addEventListener("click", () => menu.style.display = "none");

        //#endregion 

        //#region Param
        let params = {};
        let editingParamName = null;

        function editParam(name) {
            const p = params[name];
            if (!p) return;

            // Fill input
            document.getElementById("paramName").value = name;
            document.getElementById("paramValue").value = p.value;
            document.getElementById("paramGroup").value = p.group;
            document.getElementById("paramColor").value = p.color;
            document.getElementById("paramDesc").value = p.desc || "";
            document.getElementById("paramFormat").value = p.format;
            document.getElementById("addParamButton").innerHTML = "C·∫≠p nh·∫≠t";
            editingParamName = name; // ƒë√°nh d·∫•u ƒëang edit
        }

        function addParam() {
            const name = document.getElementById("paramName").value.trim();
            const value = parseFloat(document.getElementById("paramValue").value);
            const desc = document.getElementById("paramDesc").value.trim();
            const group = document.getElementById("paramGroup").value.trim();
            const color = document.getElementById("paramColor").value;
            const format = document.getElementById("paramFormat").value;

            if (!name) { alert("T√™n param kh√¥ng ƒë∆∞·ª£c r·ªóng!"); return; }
            if (isNaN(value)) { alert("Gi√° tr·ªã ph·∫£i l√† s·ªë!"); return; }

            if (editingParamName) {
                delete params[editingParamName];
                editingParamName = null;
            }

            params[name] = { value, desc, group, color, format };

            renderParams();
            updateFormulaResults();
            saveToLocal({
                params: params,
                formulas: formulas
            });

            // reset input
            document.getElementById("paramName").value = "";
            document.getElementById("paramValue").value = "";
            document.getElementById("paramDesc").value = "";
            document.getElementById("paramGroup").value = "";
            document.getElementById("paramColor").value = "#f0f0f0";
        }


        function toggleBlock(id) {
            const el = document.getElementById(id);
            const title = el.previousElementSibling; // h3
            if (el.style.display === "none") {
                el.style.display = "block";
                title.innerText = title.innerText.replace("‚ûï", "‚ûñ");
            } else {
                el.style.display = "none";
                title.innerText = title.innerText.replace("‚ûñ", "‚ûï");
            }
        }

        function deleteParam(key) {
            delete params[key];
            renderParams();
            updateFormulaResults();
        }

        // Render danh s√°ch param v·ªõi input ƒë·ªÉ ch·ªânh s·ª≠a realtime
        let groupState = {}; // L∆∞u tr·∫°ng th√°i expand/collapse c·ªßa t·ª´ng group

        function renderParams() {
            const paramsContainer = document.getElementById("params");
            paramsContainer.innerHTML = ""; // clear c≈©

            const title = document.createElement("h4");
            title.innerText = "Danh s√°ch tham s·ªë:";
            paramsContainer.appendChild(title);

            // Gom param theo group
            let grouped = {};
            for (let key in params) {
                let p = params[key];
                let g = p.group || "Ungrouped";
                if (!grouped[g]) grouped[g] = [];
                grouped[g].push({ name: key, ...p });
            }

            for (let g in grouped) {
                if (!(g in groupState)) groupState[g] = true; // m·∫∑c ƒë·ªãnh expand

                const groupDiv = document.createElement("div");
                groupDiv.className = "param-group";

                // header
                const header = document.createElement("div");
                header.className = "group-header";
                header.innerHTML = `${groupState[g] ? "‚ñº" : "‚ñ∂"} <b>${g}</b>`;
                header.addEventListener("click", () => toggleGroup(g));
                groupDiv.appendChild(header);

                // container
                const groupContainer = document.createElement("div");
                groupContainer.id = `group-${g}`;
                groupContainer.style.display = groupState[g] ? "block" : "none";
                groupContainer.style.marginLeft = "15px";
                groupDiv.appendChild(groupContainer);

                // t·ª´ng param
                grouped[g].forEach(p => {
                    const item = document.createElement("div");
                    item.className = "param-item list-item";
                    item.style.setProperty("--list-item-bg", p.color || "#fafafa");
                    item.addEventListener("contextmenu", e => openContextMenu(e, "param", p.name));

                    const inner = document.createElement("div");

                    // label + input
                    const label = document.createTextNode(`${p.name} = `);
                    inner.appendChild(label);

                    const input = document.createElement("input");
                    input.type = "text";
                    input.value = formatValue(p.value, p.format);

                    input.addEventListener("focus", () => {
                        console.log("onFocus");
                        input.value = p.value; // raw value
                    });
                    input.addEventListener("blur", () => {
                        console.log("onBlur");
                        updateParamFormatted(p.name, input.value);
                    });
                    input.addEventListener("change", () => {
                        console.log("onChange");
                        if (params[p.name]) {
                            params[p.name].value = parseFloat(input.value) || 0;
                            updateFormulaResults();
                        }
                    });

                    inner.appendChild(input);

                    // description
                    const desc = document.createElement("div");
                    desc.style.fontSize = "12px";
                    desc.style.color = "#333";
                    desc.innerText = p.desc || "";
                    inner.appendChild(desc);

                    item.appendChild(inner);
                    groupContainer.appendChild(item);
                });

                paramsContainer.appendChild(groupDiv);
            }
        }


        function updateParamFormatted(key, val) {
            console.log("updateParamFormatted");
            // lo·∫°i b·ªè k√Ω t·ª± kh√¥ng ph·∫£i s·ªë tr∆∞·ªõc
            let num = parseFloat(val.replace(/[^\d.-]/g, ""));
            if (isNaN(num)) num = 0;
            if (params[key]) {
                params[key].value = num;
                renderParams();
                updateFormulaResults();
            }
        }

        function toggleGroup(g) {
            groupState[g] = !groupState[g];
            renderParams();
        }

        //#endregion

        //#region Formula
        let formulas = {};   // key = t√™n c√¥ng th·ª©c, value = { raw, display }
        let editingFormulaName = null;

        // Format c√¥ng th·ª©c: th√™m kho·∫£ng tr·∫Øng v√† ƒë·ªïi * th√†nh √ó
        function formatFormulaDisplay(formula) {
            return formula
                .replace(/\*/g, "√ó")              // ƒë·ªïi d·∫•u nh√¢n
                .replace(/\//g, "√∑")              // c√≥ th·ªÉ ƒë·ªïi d·∫•u chia
                .replace(/([\+\-\√ó√∑])/g, " $1 ")  // th√™m kho·∫£ng tr·∫Øng quanh to√°n t·ª≠
                .replace(/\s+/g, " ")             // g·ªôp nhi·ªÅu kho·∫£ng tr·∫Øng th√†nh 1
                .trim();
        }

        function deleteFormula(name) {
            delete formulas[name];
            renderFormulas();
            updateFormulaResults();
        }

        function editFormula(name) {
            const f = formulas[name];
            if (!f) return;

            document.getElementById("formulaName").value = name;
            document.getElementById("formulaInput").value = f.raw;
            document.getElementById("formulaDesc").value = f.desc || "";

            editingFormulaName = name;
        }

        function addFormula() {
            const name = document.getElementById("formulaName").value.trim() || `C${Object.keys(formulas).length + 1}`;
            const formula = document.getElementById("formulaInput").value.trim();
            const desc = document.getElementById("formulaDesc").value.trim();

            if (!formula) { alert("Ch∆∞a nh·∫≠p c√¥ng th·ª©c!"); return; }

            // N·∫øu ƒëang edit ‚Üí x√≥a c√¥ng th·ª©c c≈©
            if (editingFormulaName) {
                document.getElementById("addFormulaButton").innerHTML = "Th√™m c√¥ng th·ª©c";
                delete formulas[editingFormulaName];
                editingFormulaName = null;
            }

            formulas[name] = {
                raw: formula,
                display: formatFormulaDisplay(formula),
                desc: desc
            };

            renderFormulas();
            updateFormulaResults();

            document.getElementById("formulaName").value = "";
            document.getElementById("formulaInput").value = "";
            document.getElementById("formulaDesc").value = "";
        }

        // Render danh s√°ch c√¥ng th·ª©c
        function renderFormulas() {
            let html = "<h4>Danh s√°ch c√¥ng th·ª©c:</h4>";
            for (let [name, f] of Object.entries(formulas)) {
                html += `
      <div class="formula-item list-item" 
            oncontextmenu="openContextMenu(event, 'formula', '${name}')"
            style="--list-item-bg:${'#dddddd'};">
        <div>
          <span><b>${name}</b>: <span id="formulaDisplay_${name}">${f.display}</span></span>
          <span id="formulaResult_${name}" class="formula-result"></span>
          <div style="font-size:12px; color:#666;">${f.desc || ""}</div>
        </div>
      </div>`;
            }
            document.getElementById("formulas").innerHTML = html;
        }

        // T√≠nh to√°n l·∫°i t·∫•t c·∫£ c√¥ng th·ª©c
        function updateFormulaResults() {
            let scope = {};
            // 1) Map params -> scope (l·∫•y field value n·∫øu l√† object)
            for (let [k, v] of Object.entries(params)) {
                scope[k] = (v && typeof v === "object" && "value" in v) ? v.value : v;
            }

            // 2) Ti√™m alias c√°c h√†m/const to√°n h·ªçc ph·ªï bi·∫øn v√†o scope
            const MATH_ALIASES = {
                ceil: Math.ceil,
                floor: Math.floor,
                round: Math.round,
                min: Math.min,
                max: Math.max,
                pow: Math.pow,
                abs: Math.abs,
                sqrt: Math.sqrt,
                log: Math.log,
                exp: Math.exp,
                sin: Math.sin,
                cos: Math.cos,
                tan: Math.tan,
                asin: Math.asin,
                acos: Math.acos,
                atan: Math.atan,
                atan2: Math.atan2,
                trunc: Math.trunc,
                random: Math.random,
                PI: Math.PI,
                E: Math.E
            };
            Object.assign(scope, MATH_ALIASES);

            // T·∫≠p t√™n ‚Äúƒë∆∞·ª£c ph√©p‚Äù ƒë·ªÉ kh√¥ng b·ªã highlight thi·∫øu
            const ALLOWED_NAMES = new Set([...Object.keys(scope), "Math"]);

            for (let [name, f] of Object.entries(formulas)) {
                try {
                    let keys = Object.keys(scope);
                    let values = Object.values(scope);

                    // Evaluate c√¥ng th·ª©c
                    let func = new Function(...keys, `return ${f.raw};`);
                    let result = func(...values);

                    // L∆∞u k·∫øt qu·∫£ v√†o scope ƒë·ªÉ c√°c c√¥ng th·ª©c sau c√≥ th·ªÉ d√πng ti·∫øp
                    scope[name] = result;

                    // Render UI
                    document.getElementById("formulaResult_" + name).innerText = " = " + result;
                    document.getElementById("formulaDisplay_" + name).innerHTML = f.display;

                } catch (e) {
                    // B·∫Øt t√™n bi·∫øn/h√†m trong raw
                    const tokens = f.raw.match(/[a-zA-Z_]\w*/g) || [];
                    // L·ªçc ra nh·ªØng t√™n ch∆∞a c√≥ trong scope v√† kh√¥ng thu·ªôc allowed (Math funcs/const)
                    const missing = tokens.filter(t => !ALLOWED_NAMES.has(t));

                    if (missing.length > 0) {
                        // highlight ƒë·ªè c√°c bi·∫øn thi·∫øu trong display
                        const highlighted = f.display.replace(
                            new RegExp("\\b(" + missing.join("|") + ")\\b", "g"),
                            '<span style="color:red;font-weight:bold;">$1</span>'
                        );
                        document.getElementById("formulaDisplay_" + name).innerHTML = highlighted;
                        document.getElementById("formulaResult_" + name).innerText =
                            " (Thi·∫øu: " + missing.join(", ") + ")";
                    } else if (/Unexpected/.test(e.message)) {
                        document.getElementById("formulaResult_" + name).innerText = " (L·ªói c√∫ ph√°p)";
                    } else {
                        document.getElementById("formulaResult_" + name).innerText = " (L·ªói: " + e.message + ")";
                    }
                }
            }
        }

        //#endregion

        // L∆∞u local m·ªói khi c√≥ thay ƒë·ªïi
        function clearWorkspace() {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° to√†n b·ªô Param v√† Formula hi·ªán t·∫°i kh√¥ng?")) return;

            params = {};
            formulas = {};
            renderParams();
            renderFormulas();
            updateFormulaResults();
            saveToLocal({ params, formulas }); // clear c·∫£ localStorage lu√¥n
        }

        function saveToLocal(data) {
            localStorage.setItem("pt-latest-data", JSON.stringify(data));
        }

        // Load khi m·ªü page
        function loadFromLocal() {
            const raw = localStorage.getItem("pt-latest-data");
            if (!raw) return;
            try {
                const data = JSON.parse(raw);
                params = data.params || {};
                formulas = data.formulas || {};
                renderParams();
                renderFormulas();
                updateFormulaResults();
            } catch (e) {
                console.error("Kh√¥ng load ƒë∆∞·ª£c d·ªØ li·ªáu local:", e);
            }
        }

        // G·ªçi khi page kh·ªüi ƒë·ªông
        window.addEventListener("DOMContentLoaded", loadFromLocal);
        // ƒêƒÉng k√Ω custom tag <auto-scroll-input>
        customElements.define("auto-scroll-input", AutoScrollInput);
        customElements.define("formatted-input", FormattedInput);

        // Ch√®n saveToLocal() v√†o cu·ªëi addParam, addFormula, deleteParam, deleteFormula

    </script>
</body>

</html>